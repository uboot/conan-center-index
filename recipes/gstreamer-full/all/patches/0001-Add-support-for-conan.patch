From 8d18ee5c48bf038248262cbb28fd2aa57826e03c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fr=C3=A9d=C3=A9ric=20Nadeau?= <fred.nadeau@gmail.com>
Date: Thu, 2 May 2024 19:38:39 -0400
Subject: [PATCH] Add support for conan

---
 .../gst-plugins-base/ext/gl/meson.build       |  4 ++++
 .../gst-libs/gst/gl/meson.build               | 23 +++++++++++++++----
 .../gst-plugins-ugly/ext/x264/gstx264enc.h    |  7 ------
 .../gst-plugins-ugly/ext/x264/meson.build     |  2 +-
 4 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/subprojects/gst-plugins-base/ext/gl/meson.build b/subprojects/gst-plugins-base/ext/gl/meson.build
index ad514014e9..e8589550a7 100644
--- a/subprojects/gst-plugins-base/ext/gl/meson.build
+++ b/subprojects/gst-plugins-base/ext/gl/meson.build
@@ -138,6 +138,10 @@ if gl_nvmm
   optional_deps += [nvbuf_utils_dep]
 endif
 
+if glext_dep.found()
+  optional_deps += glext_dep
+endif
+
 gstopengl = library('gstopengl',
   opengl_sources,
   c_args : gst_plugins_base_args + extra_c_args,
diff --git a/subprojects/gst-plugins-base/gst-libs/gst/gl/meson.build b/subprojects/gst-plugins-base/gst-libs/gst/gl/meson.build
index bbc5c8f21c..d51664333c 100644
--- a/subprojects/gst-plugins-base/gst-libs/gst/gl/meson.build
+++ b/subprojects/gst-plugins-base/gst-libs/gst/gl/meson.build
@@ -402,6 +402,10 @@ if need_api_opengl != 'no'
 # include <GL/glext.h>
 #endif
 '''
+    glext_dep = dependency('glext', method: 'pkg-config', required : false)
+    if glext_dep.found()
+      gl_lib_deps += glext_dep
+    endif
   endif
 endif
 
@@ -764,11 +768,16 @@ if host_system == 'windows' and need_win_win32 != 'no'
     have_wgl = false
     have_egl_win32 = false
     if need_platform_wgl != 'no'
-      wglext_h = cc.has_header('GL/wglext.h',
-                               prefix : '''#include <windows.h>
-                                           #include <GL/gl.h>''',
-                               include_directories : compat_includes)
-      have_wgl = wglext_h and gl_dep.found()
+      wglext_dep = dependency('wglext', method: 'pkg-config', required : false)
+      if not wglext_dep.found()
+        wglext_h = cc.has_header('GL/wglext.h',
+                                prefix : '''#include <windows.h>
+                                            #include <GL/gl.h>''',
+                                include_directories : compat_includes)
+        have_wgl = wglext_h and gl_dep.found()
+      else
+        have_wgl = wglext_dep.found()
+      endif
     endif
 
     have_egl_win32 = enabled_gl_platforms.contains('egl') and gles2_dep.found()
@@ -789,6 +798,10 @@ if host_system == 'windows' and need_win_win32 != 'no'
       ]
       enabled_gl_platforms += 'wgl'
       glconf.set('GST_GL_HAVE_PLATFORM_WGL', 1)
+      if wglext_dep.found()
+        gl_platform_deps += wglext_dep
+        gl_winsys_deps += wglext_dep
+      endif
     endif
   endif
 endif
diff --git a/subprojects/gst-plugins-ugly/ext/x264/gstx264enc.h b/subprojects/gst-plugins-ugly/ext/x264/gstx264enc.h
index 6cbfc5c3d0..ba7845b201 100644
--- a/subprojects/gst-plugins-ugly/ext/x264/gstx264enc.h
+++ b/subprojects/gst-plugins-ugly/ext/x264/gstx264enc.h
@@ -31,13 +31,6 @@
 #include <stdint.h>
 #endif
 
-/* The x264.h header says this isn't needed with MinGW, but sometimes the
- * compiler is unable to correctly do the pointer indirection for us, which
- * leads to a segfault when you try to dereference any const values provided
- * by x264.dll. See: https://bugzilla.gnome.org/show_bug.cgi?id=779249 */
-#if defined(_WIN32) && !defined(X264_API_IMPORTS)
-# define X264_API_IMPORTS
-#endif
 #include <x264.h>
 
 G_BEGIN_DECLS
diff --git a/subprojects/gst-plugins-ugly/ext/x264/meson.build b/subprojects/gst-plugins-ugly/ext/x264/meson.build
index f5e2b585b6..cb1f30709f 100644
--- a/subprojects/gst-plugins-ugly/ext/x264/meson.build
+++ b/subprojects/gst-plugins-ugly/ext/x264/meson.build
@@ -8,7 +8,7 @@ x264_sources = [
   'gstencoderbitrateprofilemanager.c',
 ]
 
-x264_dep = dependency('x264', version : '>=0.156', required : x264_opt,
+x264_dep = dependency('x264', required : x264_opt,
                       fallback: ['x264', 'libx264_dep'])
 
 if x264_dep.found()
-- 
2.32.0.windows.1

